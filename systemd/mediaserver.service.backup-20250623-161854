# Enhanced Media Server Systemd Service
# =======================================
# This service manages the Docker Compose stack for the media server with enhanced boot reliability
# Install to: /etc/systemd/system/mediaserver.service

[Unit]
Description=Enhanced Media Server Docker Stack
Documentation=https://github.com/yourusername/mediaserver-enhanced
After=docker.service network-online.target multi-user.target
Wants=network-online.target
Requires=docker.service
StartLimitIntervalSec=600
StartLimitBurst=5

[Service]
Type=oneshot
RemainAfterExit=yes
User=root
Group=root
WorkingDirectory=/home/matthewhans/mediaserver-enhanced

# Environment variables
Environment=COMPOSE_PROJECT_NAME=mediaserver
Environment=COMPOSE_HTTP_TIMEOUT=300
Environment=DOCKER_CLIENT_TIMEOUT=300

# Pre-start cleanup and validation
ExecStartPre=-/bin/bash -c 'echo "Starting mediaserver service at $(date)"'
ExecStartPre=-/usr/bin/docker-compose down --remove-orphans
ExecStartPre=-/usr/bin/docker container prune -f
ExecStartPre=-/usr/bin/docker network prune -f
ExecStartPre=/bin/bash -c 'if [ ! -f /home/matthewhans/mediaserver-enhanced/docker-compose.yml ]; then echo "ERROR: docker-compose.yml not found"; exit 1; fi'

# Enhanced boot process using boot manager
ExecStart=/home/matthewhans/mediaserver-enhanced/scripts/boot-manager.sh start

# Stop command
ExecStop=/usr/bin/docker-compose down --timeout 30
ExecStopPost=-/usr/bin/docker container prune -f

# Reload command
ExecReload=/bin/bash -c 'cd /home/matthewhans/mediaserver-enhanced && /usr/bin/docker-compose pull --quiet && /usr/bin/docker-compose up -d --remove-orphans'

# Enhanced restart and recovery policies
Restart=on-failure
RestartSec=60
TimeoutStartSec=600
TimeoutStopSec=180
TimeoutAbortSec=30

# Security hardening
NoNewPrivileges=false
PrivateTmp=true
ProtectSystem=false
ReadWritePaths=/home/matthewhans/mediaserver-enhanced /mnt/media /mnt/downloads /var/log /tmp

# Logging configuration
StandardOutput=journal
StandardError=journal
SyslogIdentifier=mediaserver

# Additional service dependencies and ordering
Before=
WantedBy=multi-user.target

[Install]
WantedBy=multi-user.target

# Installation and Usage Instructions:
# ====================================
# 1. Stop existing service: sudo systemctl stop mediaserver.service
# 2. Copy this file: sudo cp mediaserver.service /etc/systemd/system/
# 3. Reload systemd: sudo systemctl daemon-reload
# 4. Enable service: sudo systemctl enable mediaserver.service
# 5. Start service: sudo systemctl start mediaserver.service
# 6. Check status: sudo systemctl status mediaserver.service
# 7. View logs: sudo journalctl -u mediaserver.service -f
#
# Troubleshooting:
# - Check boot manager logs: tail -f /home/matthewhans/mediaserver-enhanced/logs/boot-manager.log
# - Manual boot test: sudo /home/matthewhans/mediaserver-enhanced/scripts/boot-manager.sh start
# - Service restart: sudo systemctl restart mediaserver.service